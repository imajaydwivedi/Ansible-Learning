---
- name: Send Slack message using Slack Bot OAuth Token
  hosts: localhost
  become_user: root
  remote_user: ansible
  become: true
  gather_facts: false
  vars:
    slack_token: "{{ lookup('env', 'SLACK_BOT_TOKEN') }}"  # or hardcode token here
    slack_channel: "#sqlmonitor-alerts"  # or Slack channel ID like C12345678
    slack_channel_id: "C04LKQF9RGV"
    slack_thread_header: '*Patroni Cluster State on PostgreSQL Servers*'
    slack_message: |
      "+ Cluster: facebook-prod-rpt (7483087698268431571) --------+---------+----+-----------+",
      "| Member            | Host                                  | Role    | State   | TL | Lag in MB |",
      "+-------------------+---------------------------------------+---------+---------+----+-----------+",
      "| facebok-postgres0 | facebok-postgres0.prod.lab.com        | Replica | stopped |    |   unknown |",
      "| facebok-postgres1 | facebok-postgres1.prod.lab.com        | Replica | stopped |    |   unknown |",
      "| facebok-postgres2 | facebok-postgres2.prod.lab.com        | Replica | stopped |    |   unknown |",
      "+-------------------+---------------------------------------+---------+---------+----+-----------+"
    slack_message_coded: |
      ```
      "+ Cluster: facebook-prod-rpt (7483087698268431571) --------+---------+----+-----------+",
      "| Member            | Host                                  | Role    | State   | TL | Lag in MB |",
      "+-------------------+---------------------------------------+---------+---------+----+-----------+",
      "| facebok-postgres0 | facebok-postgres0.prod.lab.com        | Replica | stopped |    |   unknown |",
      "| facebok-postgres1 | facebok-postgres1.prod.lab.com        | Replica | stopped |    |   unknown |",
      "| facebok-postgres2 | facebok-postgres2.prod.lab.com        | Replica | stopped |    |   unknown |",
      "+-------------------+---------------------------------------+---------+---------+----+-----------+"
      ```
    slack_message_coded2: |
      ```
      {{ slack_message }}
      ```
    slack_message_coded3: "``` {{ slack_message }} ```"

  tasks:
    - name: Send Slack message using community.general.slack
      community.general.slack:
        token: "{{ slack_token }}"
        msg: "{{ slack_message_coded2 }}"
        channel: "{{ slack_channel }}"
        # username: "AnsibleBot"
        icon_emoji: ":robot_face:"
        parse: "full"
      # delegate_to: localhost

    - name: Send notification message via Slack all options
      community.general.slack:
        token: "{{ slack_token }}"
        msg: '{{ inventory_hostname }} completed'
        channel: "{{ slack_channel_id }}"
        thread_id: '1539917263.000100'
        username: 'Ansible on {{ inventory_hostname }}'
        icon_url: http://www.example.com/some-image-file.png
        link_names: 0
        parse: 'none'
      # delegate_to: localhost

    - name: Insert a color bar in front of the message for visibility purposes and use the default webhook icon and name configured
        in Slack
      community.general.slack:
        token: "{{ slack_token }}"
        channel: "{{ slack_channel }}"
        msg: '{{ inventory_hostname }} is alive!'
        color: good
        username: ''
        icon_url: ''

    - name: Insert a color bar in front of the message with valid hex color value
      community.general.slack:
        token: "{{ slack_token }}"
        channel: "{{ slack_channel }}"
        msg: 'This message uses color in hex value'
        color: '#00aacc'
        username: ''
        icon_url: ''

    - name: Use the attachments API
      community.general.slack:
        token: "{{ slack_token }}"
        channel: "{{ slack_channel }}"
        attachments:
          - text: Display my system load on host A and B
            color: '#ff00dd'
            title: System load
            fields:
              - title: System A
                value: "load average: 0,74, 0,66, 0,63"
                short: true
              - title: System B
                value: 'load average: 5,16, 4,64, 2,43'
                short: true

    - name: Use the blocks API
      community.general.slack:
        token: "{{ slack_token }}"
        channel: "{{ slack_channel }}"
        blocks:
          - type: section
            text:
              type: mrkdwn
              text: |-
                *System load*
                Display my system load on host A and B
          - type: context
            elements:
              - type: mrkdwn
                text: |-
                  *System A*
                  load average: 0,74, 0,66, 0,63
              - type: mrkdwn
                text: |-
                  *System B*
                  load average: 5,16, 4,64, 2,43

    - name: Send a message with a link using Slack markup
      community.general.slack:
        token: "{{ slack_token }}"
        channel: "{{ slack_channel }}"
        msg: We sent this message using <https://www.ansible.com|Ansible>!

    - name: Send a message with angle brackets and ampersands
      community.general.slack:
        token: "{{ slack_token }}"
        channel: "{{ slack_channel }}"
        msg: This message has &lt;brackets&gt; &amp; ampersands in plain text.

    - name: Initial Threaded Slack message
      community.general.slack:
        channel: "{{ slack_channel }}"
        token: "{{ slack_token }}"
        msg: 'Starting a thread with my initial post.'
      register: slack_response

    - name: Add more info to thread
      community.general.slack:
        channel: "{{ slack_channel }}"
        token: "{{ slack_token }}"
        thread_id: "{{ slack_response['ts'] }}"
        color: good
        msg: 'And this is my threaded response!'

    - name: Add code block to thread
      community.general.slack:
        channel: "{{ slack_channel }}"
        token: "{{ slack_token }}"
        thread_id: "{{ slack_response['ts'] }}"
        # color: good
        msg: "{{ slack_message_coded3 }}"
        parse: "full"

    - name: Send a message to be edited later on
      community.general.slack:
        token: "{{ slack_token }}"
        channel: "{{ slack_channel }}"
        msg: Deploying something...
      register: slack_response

    - name: Edit message
      community.general.slack:
        token: "{{ slack_token }}"
        # The 'channel' option does not accept the channel name. It must use the 'channel_id',
        # which can be retrieved for example from 'slack_response' from the previous task.
        channel: "{{ slack_response.channel }}"
        msg: Deployment complete!
        message_id: "{{ slack_response.ts }}"


    # https://stackoverflow.com/a/78933760


# nano ~/.bashrc
# export SLACK_BOT_TOKEN=xoxb-your-slack-bot-token